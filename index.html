<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Map</title>
    <link rel="stylesheet" href="./lib/leaflet/leaflet.css" />
    <link
      rel="stylesheet"
      href="./lib/leaflet.markercluster/MarkerCluster.css"
    />
    <link
      rel="stylesheet"
      href="./lib/leaflet.markercluster/MarkerCluster.Default.css"
    />
    <link rel="stylesheet" href="./lib/dat.gui/dat.gui.css" />
    <style>
      body {
        margin: 0;
        background-color: #111;
      }
      #map {
        height: 100vh;
        z-index: 0;
      }
      #controls {
        position: fixed;
        bottom: 100px;
        right: 10px;
        z-index: 1;
      }
      .leaflet-zoom-animated img.leaflet-tile {
        filter: invert(0.4) grayscale(1) saturate(0.5) brightness(1.6)
          opacity(0) hue-rotate(334deg) sepia(1%);
      }
    </style>
  </head>
  <body>
    <div id="map"></div>
    <script src="./lib/leaflet/leaflet.js"></script>
    <script src="./lib/leaflet.markercluster/leaflet.markercluster.js"></script>
    <script src="./lib/leaflet.motion/leaflet.motion.min.js"></script>
    <script src="./lib/dat.gui/dat.gui.min.js"></script>
    <script>
      var tiandituKey = "44964a97c8c44e4d04efdf3cba594467";

      var gaodeNormalMapUrl =
          "http://webrd0{s}.is.autonavi.com/appmaptile?lang=zh_cn&size=1&scale=1&style=8&x={x}&y={y}&z={z}",
        gaodeSatelliteMapUrl =
          "http://webst0{s}.is.autonavi.com/appmaptile?style=6&x={x}&y={y}&z={z}",
        gaodeAnnotionMapUrl =
          "http://webst0{s}.is.autonavi.com/appmaptile?style=8&x={x}&y={y}&z={z}",
        osmNormalMapUrl = "https://{s}.tile.osm.org/{z}/{x}/{y}.png",
        tiandituSatelliteMapUrl =
          "http://t{s}.tianditu.gov.cn/DataServer?T=img_w&X={x}&Y={y}&L={z}&tk=" +
          tiandituKey,
        tiandituAnnotionMapUrl =
          "http://t{s}.tianditu.gov.cn/DataServer?T=cia_w&X={x}&Y={y}&L={z}&tk=" +
          tiandituKey;

      var gaodeNormalMap = L.tileLayer(gaodeNormalMapUrl, {
          subdomains: "1234",

          maxZoom: 21,

          minZoom: 3,

          coordType: "gcj02",
        }),
        gaodeNormalMapOp = L.tileLayer(gaodeNormalMapUrl, {
          subdomains: "1234",

          maxZoom: 21,

          minZoom: 3,

          opacity: 0.6,

          coordType: "gcj02",
        }),
        gaodeSatelliteMap = L.tileLayer(gaodeSatelliteMapUrl, {
          subdomains: "1234",

          maxZoom: 21,

          minZoom: 3,

          coordType: "gcj02",
        }),
        gaodeSatelliteMapOp = L.tileLayer(gaodeSatelliteMapUrl, {
          subdomains: "1234",

          maxZoom: 21,

          minZoom: 3,

          opacity: 0.6,

          coordType: "gcj02",
        }),
        gaodeAnnotionMap = L.tileLayer(gaodeAnnotionMapUrl, {
          subdomains: "1234",

          maxZoom: 21,

          minZoom: 3,

          coordType: "gcj02",
        }),
        osmNormalMap = L.tileLayer(osmNormalMapUrl, {
          subdomains: "abc",

          maxZoom: 21,

          minZoom: 3,

          coordType: "gcj02",
        }),
        osmNormalMapOp = L.tileLayer(osmNormalMapUrl, {
          subdomains: "abc",

          maxZoom: 21,

          minZoom: 3,

          opacity: 0.6,
        }),
        tiandituSatelliteMap = L.tileLayer(tiandituSatelliteMapUrl, {
          subdomains: "01234567",

          maxZoom: 21,

          minZoom: 3,
        }),
        tiandituSatelliteMapOp = L.tileLayer(tiandituSatelliteMapUrl, {
          subdomains: "01234567",

          maxZoom: 21,

          minZoom: 3,

          opacity: 0.6,
        }),
        tiandituAnnotionMap = L.tileLayer(tiandituAnnotionMapUrl, {
          subdomains: "01234567",

          maxZoom: 21,

          minZoom: 3,
        });

      var baseLayers = {
        高德地图: gaodeNormalMap,

        高德影像: gaodeSatelliteMap,

        OSM地图: osmNormalMap,

        天地图影像: tiandituSatelliteMap,
      };

      var overlayLayers = {
        高德标注: gaodeAnnotionMap,

        高德地图半透明: gaodeNormalMapOp,

        高德影像半透明: gaodeSatelliteMapOp,

        天地图标注: tiandituAnnotionMap,

        OSM地图半透明: osmNormalMapOp,

        天地图影像半透明: tiandituSatelliteMapOp,
      };

      var map = new L.Map("map", {
        renderer: L.canvas(),
        center: [38.04157360367438, 114.4793051147461],
        zoom: 12,
        layers: [gaodeNormalMap],
      });

      L.control.layers(baseLayers, overlayLayers).addTo(map);

      // // leaflet的加载网格图层方法，它是L.TileLayer的基类，更新_setZoomTransform、_getTiledPixelBounds方法

      L.GridLayer.include({
        _setZoomTransform: function (level, center, zoom) {
          if (center != undefined && this.options) {
            // 把鼠标坐标由WGS84坐标系转为DB09或GCJ02坐标系，leaflet从图面上获取的坐标是WGS84坐标系的，需要转换到瓦片对应的坐标系，才能匹配瓦片

            if (this.options.coordType == "gcj02") {
              center = L.coordTransform().wgs84_To_gcj02(
                center.lng,
                center.lat
              );
            } else if (this.options.coordType == "bd09") {
              center = L.coordTransform().wgs84_To_bd09(center.lng, center.lat);
            }
          }

          var viewHalf = this._map.getSize().divideBy(2);

          var mapProject = this._map.project(center, zoom);

          var mapPanePos = this._map._mapPane._leaflet_pos;

          var newPixelOrigin = mapProject
            .subtract(viewHalf)
            ._add(mapPanePos)
            .round();

          console.log("viewHalf:" + viewHalf);

          console.log("mapProject:" + mapProject);

          console.log("mapPanePos:" + mapPanePos);

          console.log("newPixelOrigin:" + newPixelOrigin);

          var scale = this._map.getZoomScale(zoom, level.zoom),
            translate = level.origin
              .multiplyBy(scale)

              .subtract(newPixelOrigin)
              .round();

          console.log("scale:" + scale);

          console.log("translate:" + translate);

          if (L.Browser.any3d) {
            L.DomUtil.setTransform(level.el, translate, scale);
          } else {
            L.DomUtil.setPosition(level.el, translate);
          }
        },

        // 获取地图容器像素四至，根据修改后的鼠标中心点获取

        _getTiledPixelBounds: function (center) {
          if (center != undefined && this.options) {
            if (this.options.coordType == "gcj02") {
              center = L.coordTransform().wgs84_To_gcj02(
                center.lng,
                center.lat
              );
            } else if (this.options.coordType == "bd09") {
              center = L.coordTransform().wgs84_To_bd09(center.lng, center.lat);
            }
          }

          var map = this._map,
            mapZoom = map._animatingZoom
              ? Math.max(map._animateToZoom, map.getZoom())
              : map.getZoom(),
            scale = map.getZoomScale(mapZoom, this._tileZoom),
            pixelCenter = map.project(center, this._tileZoom).floor(),
            halfSize = map.getSize().divideBy(scale * 2);

          return new L.Bounds(
            pixelCenter.subtract(halfSize),
            pixelCenter.add(halfSize)
          );
        },
      });

      L.CoordTransform = function () {
        //bd09转wgs84

        this.bd09_To_wgs84 = function (lng, lat) {
          var gcj02 = this.bd09_To_gcj02(lng, lat);

          var wgs84 = this.gcj02_To_wgs84(gcj02.lng, gcj02.lat);

          return wgs84;
        };

        //wgs84转bd09

        this.wgs84_To_bd09 = function (lng, lat) {
          var gcj02 = this.wgs84_To_gcj02(lng, lat);

          var bd09 = this.gcj02_To_bd09(gcj02.lng, gcj02.lat);

          return bd09;
        };

        //wgs84转gcj02

        this.wgs84_To_gcj02 = function (lng, lat) {
          var dLat = transformLat(lng - 105.0, lat - 35.0);

          var dLng = transformLng(lng - 105.0, lat - 35.0);

          var radLat = (lat / 180.0) * pi;

          var magic = Math.sin(radLat);

          magic = 1 - ee * magic * magic;

          var sqrtMagic = Math.sqrt(magic);

          dLat = (dLat * 180.0) / (((a * (1 - ee)) / (magic * sqrtMagic)) * pi);

          dLng = (dLng * 180.0) / ((a / sqrtMagic) * Math.cos(radLat) * pi);

          var mgLat = lat + dLat;

          var mgLng = lng + dLng;

          var newCoord = {
            lng: mgLng,

            lat: mgLat,
          };

          return newCoord;
        };

        //gcj02转wgs84

        this.gcj02_To_wgs84 = function (lng, lat) {
          var coord = transform(lng, lat);

          var lontitude = lng * 2 - coord.lng;

          var latitude = lat * 2 - coord.lat;

          var newCoord = {
            lng: lontitude,

            lat: latitude,
          };

          return newCoord;
        };

        //gcj02转bd09

        this.gcj02_To_bd09 = function (lng, lat) {
          var z =
            Math.sqrt(lng * lng + lat * lat) + 0.00002 * Math.sin(lat * x_pi);

          var theta = Math.atan2(lat, lng) + 0.000003 * Math.cos(lng * x_pi);

          var bd_lng = z * Math.cos(theta) + 0.0065;

          var bd_lat = z * Math.sin(theta) + 0.006;

          var newCoord = {
            lng: bd_lng,

            lat: bd_lat,
          };

          return newCoord;
        };

        //bg09转gcj02

        this.bd09_To_gcj02 = function (lng, lat) {
          var x = lng - 0.0065;

          var y = lat - 0.006;

          var z = Math.sqrt(x * x + y * y) - 0.00002 * Math.sin(y * x_pi);

          var theta = Math.atan2(y, x) - 0.000003 * Math.cos(x * x_pi);

          var lontitude = z * Math.cos(theta);

          var latitude = z * Math.sin(theta);

          var newCoord = {
            lng: lontitude,

            lat: latitude,
          };

          return newCoord;
        };

        var pi = 3.1415926535897932384626;

        var a = 6378245.0;

        var ee = 0.00669342162296594323;

        var x_pi = (pi * 3000.0) / 180.0;

        var R = 6378137;

        function transform(lng, lat) {
          var dLat = transformLat(lng - 105.0, lat - 35.0);

          var dLng = transformLng(lng - 105.0, lat - 35.0);

          var radLat = (lat / 180.0) * pi;

          var magic = Math.sin(radLat);

          magic = 1 - ee * magic * magic;

          var sqrtMagic = Math.sqrt(magic);

          dLat = (dLat * 180.0) / (((a * (1 - ee)) / (magic * sqrtMagic)) * pi);

          dLng = (dLng * 180.0) / ((a / sqrtMagic) * Math.cos(radLat) * pi);

          var mgLat = lat + dLat;

          var mgLng = lng + dLng;

          var newCoord = {
            lng: mgLng,

            lat: mgLat,
          };

          return newCoord;
        }

        function transformLat(x, y) {
          var ret =
            -100.0 +
            2.0 * x +
            3.0 * y +
            0.2 * y * y +
            0.1 * x * y +
            0.2 * Math.sqrt(Math.abs(x));

          ret +=
            ((20.0 * Math.sin(6.0 * x * pi) + 20.0 * Math.sin(2.0 * x * pi)) *
              2.0) /
            3.0;

          ret +=
            ((20.0 * Math.sin(y * pi) + 40.0 * Math.sin((y / 3.0) * pi)) *
              2.0) /
            3.0;

          ret +=
            ((160.0 * Math.sin((y / 12.0) * pi) +
              320 * Math.sin((y * pi) / 30.0)) *
              2.0) /
            3.0;

          return ret;
        }

        function transformLng(x, y) {
          var ret =
            300.0 +
            x +
            2.0 * y +
            0.1 * x * x +
            0.1 * x * y +
            0.1 * Math.sqrt(Math.abs(x));

          ret +=
            ((20.0 * Math.sin(6.0 * x * pi) + 20.0 * Math.sin(2.0 * x * pi)) *
              2.0) /
            3.0;

          ret +=
            ((20.0 * Math.sin(x * pi) + 40.0 * Math.sin((x / 3.0) * pi)) *
              2.0) /
            3.0;

          ret +=
            ((150.0 * Math.sin((x / 12.0) * pi) +
              300.0 * Math.sin((x / 30.0) * pi)) *
              2.0) /
            3.0;

          return ret;
        }
      };

      L.coordTransform = function () {
        return new L.CoordTransform();
      };

      // 聚合图
      {
        const markers = new L.MarkerClusterGroup();
        const markersList = [];

        function populate() {
          for (var i = 0; i < 100; i++) {
            var m = new L.Marker(getRandomLatLng(map));
            markersList.push(m);
            markers.addLayer(m);
          }
          return false;
        }
        function populateRandomVector() {
          for (var i = 0, latlngs = [], len = 20; i < len; i++) {
            latlngs.push(getRandomLatLng(map));
          }
          var path = new L.Polyline(latlngs);
          map.addLayer(path);
        }
        function getRandomLatLng(map) {
          var bounds = map.getBounds(),
            southWest = bounds.getSouthWest(),
            northEast = bounds.getNorthEast(),
            lngSpan = northEast.lng - southWest.lng,
            latSpan = northEast.lat - southWest.lat;

          return new L.LatLng(
            southWest.lat + latSpan * Math.random(),
            southWest.lng + lngSpan * Math.random()
          );
        }

        markers.on("clusterclick", function (a) {
          console.log("cluster " + a.layer.getAllChildMarkers().length);
        });

        populate();
        map.addLayer(markers);
      }

      // 轨迹图
      {
        // Create all the polylines, initialise their settings but don't add them to the map.
        var trackPolyline = L.motion
          .polyline(
            [
              [114.25609588623047, 38.00833669718854],
              [114.26708221435545, 38.01591062130842],
              [114.27051544189453, 38.03294908916503],
              [114.28287506103514, 38.04052046968823],
              [114.2911148071289, 38.04322434446539],
              [114.29832458496092, 38.05025395161289],
              [114.30999755859375, 38.055390545366365],
              [114.32201385498045, 38.057282883777745],
              [114.3343734741211, 38.05809387097575],
              [114.34089660644531, 38.06322991452768],
              [114.34776306152344, 38.08512163459141],
              [114.38690185546875, 38.09998264736481],
              [114.4232940673828, 38.109708219514644],
              [114.45213317871094, 38.109708219514644],
              [114.47616577148438, 38.11105889102871],
              [114.50672149658203, 38.102954487322954],
              [114.54345703125, 38.0986317710631],
              [114.57023620605467, 38.09484918456411],
              [114.59907531738283, 38.0916068117397],
              [114.61761474609375, 38.07836562996712],
              [114.63237762451172, 38.0721495544091],
              [114.6591567993164, 38.06620324865703],
              [114.69863891601562, 38.04782070244462],
              [114.72198486328124, 38.042142806535615],
              [114.76352691650392, 38.042953961480585],
              [114.8133087158203, 38.03619406237626],
              [114.84317779541016, 38.041061252631025],
              [114.86686706542969, 38.039979682751806],
              [114.88780975341798, 38.04160203158016],
              [114.93621826171875, 38.03889809689809],
            ].map((d) => d.reverse())
          )
          .motionDuration(1000);
        var shipPolyline = L.motion
          .polyline(
            [
              [114.3893051147461, 38.00157360367438],
              [114.39754486083984, 38.002655740556705],
              [114.41368103027344, 38.003737861469666],
              [114.44149017333984, 38.00427891593763],
              [114.47479248046875, 38.004008389202696],
              [114.48715209960938, 38.00184413939208],
              [114.49195861816406, 38.00022091011484],
              [114.49882507324219, 38.00022091011484],
              [114.52972412109375, 38.001303066958606],
              [114.55684661865234, 38.00184413939208],
              [114.56817626953125, 38.00292627228207],
              [114.57195281982422, 38.00563153464076],
              [114.57092285156249, 38.02267239225365],
              [114.57057952880858, 38.04646886240443],
              [114.57229614257812, 38.055390545366365],
              [114.57126617431639, 38.06701413699389],
              [114.554443359375, 38.0729603768343],
              [114.54036712646484, 38.07512252602562],
              [114.50912475585936, 38.07917638348108],
              [114.47719573974608, 38.083500250411525],
              [114.4617462158203, 38.08512163459141],
            ].map((d) => d.reverse())
          )
          .motionDuration(9000);

        // Build the Sequence Group:

        // var seqGroup = L.motion.seq([trackPolyline, shipPolyline]).addTo(map);

        // Start the motion (you could put this in a timer, or some other event)
        // seqGroup.motionStart();

        // End of Example
        // Demo Buttons
      }

      // GUI
      {
        const gui = new dat.GUI();
        const folder1 = gui.addFolder("底图样式");
        folder1.open();
        const style = {
          invert: 0,
          grayscale: 0,
          saturate: 1,
          brightness: 1,
          opacity: 1,
          "hue-rotate": 0,
          sepia: 1,
        };

        folder1.add(style, "invert", 0, 1, 0.1).onChange(changeStyle);
        folder1.add(style, "grayscale", 0, 1, 0.1).onChange(changeStyle);
        folder1.add(style, "saturate", 0, 1, 0.1).onChange(changeStyle);
        folder1.add(style, "brightness", 0, 2, 0.1).onChange(changeStyle);
        folder1.add(style, "opacity", 0, 1, 0.1).onChange(changeStyle);
        folder1.add(style, "hue-rotate", 0, 360, 1).onChange(changeStyle);
        folder1.add(style, "sepia", 0, 100, 1).onChange(changeStyle);
        map.on("moveend", changeStyle);
        changeStyle();
        function changeStyle() {
          document
            .querySelectorAll(".leaflet-zoom-animated img.leaflet-tile")
            .forEach((ele) => {
              ele.style.filter = `invert(${style.invert.toFixed(
                1
              )}) grayscale(${style.grayscale.toFixed(
                2
              )}) saturate(${style.saturate.toFixed(
                2
              )}) brightness(${style.brightness.toFixed(
                2
              )}) opacity(${style.opacity.toFixed(2)}) hue-rotate(${parseInt(
                style["hue-rotate"]
              )}deg) sepia(${style.sepia.toFixed(1)}%)`;
            });
        }

        const funcs = {
          tracks_1() {
            L.motion.seq([trackPolyline]).addTo(map).motionStart();
          },
          tracks_2() {
            L.motion.seq([shipPolyline]).addTo(map).motionStart();
          },
        };
        const folder2 = gui.addFolder("轨迹");
        folder2.open();
        folder2.add(funcs, "tracks_1").name("轨迹一");
        folder2.add(funcs, "tracks_2").name("轨迹二");
      }
    </script>
  </body>
</html>
